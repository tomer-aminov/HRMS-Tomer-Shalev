<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>HRMS - Employee Profile</title>
      <link
         href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
         rel="stylesheet"
         type="text/css"
      />
      <link
         href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
         rel="stylesheet"
      />

      <link
         href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
         rel="stylesheet"
      />
      <link href="css/hrms-admin.css" rel="stylesheet" />
   </head>
   <body id="page-top">
      <div id="wrapper">
         <ul
            class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion"
            id="accordionSidebar"
         >
            <!-- Sidebar - Brand -->
            <a
               class="sidebar-brand d-flex align-items-center justify-content-center"
               href="index.html"
            >
               <div class="sidebar-brand-icon">
                  <img
                     src="logo.png"
                     alt="HRMS Logo"
                     style="width: 40px; height: 40px; object-fit: contain"
                  />
               </div>
               <div class="sidebar-brand-text mx-3">HRMS</div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0" />

            <!-- Nav Item - Dashboard -->
            <li class="nav-item">
               <a class="nav-link" href="HomePageForEmp.html">
                  <i class="fas fa-fw fa-tachometer-alt"></i>
                  <span>Dashboard</span></a
               >
            </li>

            <!-- Nav Item - Profile -->
            <li class="nav-item active">
               <a class="nav-link" href="EmpProfile.html">
                  <i class="fas fa-fw fa-user"></i>
                  <span>הפרופיל שלי</span></a
               >
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block" />
         </ul>
         <!-- Until here side navigaton -->
         <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
               <!-- Topbar -->
               <nav
                  class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow"
               >
                  <!-- Sidebar Toggle (Topbar) -->
                  <button
                     id="sidebarToggleTop"
                     class="btn btn-link d-md-none rounded-circle mr-3"
                  >
                     <i class="fa fa-bars"></i>
                  </button>

                  <!-- Topbar Navbar -->
                  <ul class="navbar-nav ml-auto">
                     <div class="topbar-divider d-none d-sm-block"></div>

                     <!-- Nav Item - User Information -->
                     <li class="nav-item dropdown no-arrow">
                        <a
                           class="nav-link dropdown-toggle"
                           href="#"
                           id="userDropdown"
                           role="button"
                           data-toggle="dropdown"
                           aria-haspopup="true"
                           aria-expanded="false"
                        >
                           <span class="mr-2 text-gray-600 small" id="userName"
                              >משתמש</span
                           >
                        </a>
                        <!-- Dropdown - User Information -->
                        <div
                           class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                           aria-labelledby="userDropdown"
                        >
                           <a class="dropdown-item" href="#" id="logoutBtn">
                              <i
                                 class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"
                              ></i>
                              התנתקות
                           </a>
                        </div>
                     </li>
                  </ul>
               </nav>
               <!-- End of Topbar -->

               <!-- Begin Page Content -->
               <div class="container-fluid">
                  <!-- Page Heading -->
                  <div class="d-sm-flex align-items-center justify-content-between mb-4">
                     <h1 class="h3 mb-0 text-gray-800">הפרופיל שלי</h1>
                     <a href="HomePageForEmp.html" class="btn btn-primary btn-sm">
                       
                        חזרה  <i class="fas fa-arrow-right fa-sm"></i>
                     </a>
                  </div>

                  <!-- Content Row -->
                  <div class="row">
                     <!-- פרטי המשתמש -->
                     <div class="col-xl-6 col-lg-6">
                        <div class="card shadow mb-4">
                           <div class="card-header py-3">
                              <h6 class="m-0 font-weight-bold text-primary">פרטים אישיים</h6>
                           </div>
                           <div class="card-body">
                              <div class="row mb-3">
                                 <div class="col-sm-4">
                                    <strong>שם פרטי:</strong>
                                 </div>
                                 <div class="col-sm-8" id="userFirstName">
                                    -
                                 </div>
                              </div>
                              <div class="row mb-3">
                                 <div class="col-sm-4">
                                    <strong>שם משפחה:</strong>
                                 </div>
                                 <div class="col-sm-8" id="userLastName">
                                    -
                                 </div>
                              </div>
                              <div class="row mb-3">
                                 <div class="col-sm-4">
                                    <strong>אימייל:</strong>
                                 </div>
                                 <div class="col-sm-8" id="userEmail">
                                    -
                                 </div>
                              </div>
                              <div class="row mb-3">
                                 <div class="col-sm-4">
                                    <strong>מספר טלפון:</strong>
                                 </div>
                                 <div class="col-sm-8" id="userPhone">
                                    -
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>

                     <!-- ניהול קובץ CV -->
                     <div class="col-xl-6 col-lg-6">
                        <div class="card shadow mb-4">
                           <div class="card-header py-3">
                              <h6 class="m-0 font-weight-bold text-primary">ניהול קובץ קורות חיים</h6>
                           </div>
                           <div class="card-body">
                              <!-- מצב קובץ קיים -->
                              <div id="existingFileSection" style="display: none;">
                                 <div class="alert alert-info">
                                    <h6><i class="fas fa-file-pdf"></i>  קיים קובץ קורות חיים </h6>
                                    <p id="existingFileName" class="mb-2"></p>
                                    <div class="btn-group" role="group">
                                       <button type="button" class="btn btn-primary btn-sm" onclick="viewFile()">
                                          <i class="fas fa-eye"></i> צפייה
                                       </button>
                                       <button type="button" class="btn btn-danger btn-sm" onclick="deleteFile()">
                                          <i class="fas fa-trash"></i> מחיקה
                                       </button>
                                    </div>
                                 </div>
                              </div>

                              <!-- העלאת קובץ חדש -->
                              <div id="uploadSection">
                                 <form id="cvUploadForm" enctype="multipart/form-data">
                                    <div class="form-group">
                                       <label for="cvFile">העלאת קובץ</label>
                                       <input type="file" class="form-control-file" id="cvFile" name="cvFile" 
                                              accept=".pdf,.doc,.docx" required>
                                              <small class="form-text text-muted">
                                                בלבד PDF נתמך פורמט
                                             </small>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                       <i class="fas fa-upload"></i> העלה קובץ
                                    </button>
                                 </form>
                              </div>

                              <!-- הודעות -->
                              <div id="messageArea" class="mt-3"></div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
               <!-- End of Main Content -->

               <!-- Footer -->
               <footer class="sticky-footer bg-white">
                  <div class="container my-auto">
                     <div class="copyright text-center my-auto">
                        <span> &copy; HRMS - Tomer & Shalev</span>
                     </div>
                  </div>
               </footer>
               <!-- End of Footer -->
            </div>
         </div>
      </div>
      <!-- Closing  <div id="wrapper"> -->
   </body>
   <script src="vendor/jquery/jquery.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

   <!-- Custom scripts for all pages-->
   <script src="js/hrms-admin.min.js"></script>
   <script src="js/config.js"></script>

   <!-- Profile Management Script -->
   <script>
      let currentUser = null;
   
      document.addEventListener('DOMContentLoaded', function () {
         // בדיקה אם המשתמש מחובר
         const userData = localStorage.getItem('currentUser')
         if (!userData) {
            window.location.href = 'index.html'
            return
         }

         currentUser = JSON.parse(userData)

         // בדיקה שהמשתמש הוא employee
         if (currentUser.role !== 'employee') {
            localStorage.removeItem('currentUser')
            window.location.href = 'index.html'
            return
         }

         // הצג את פרטי המשתמש
         displayUserInfo()
         
         // טען את פרטי הקובץ הקיים
         loadCvFileInfo()

         // הצג את שם המשתמש
         const userNameElement = document.getElementById('userName')
         userNameElement.textContent = `${currentUser.firstName} ${currentUser.lastName}`

         // כפתור התנתקות
         const logoutBtn = document.getElementById('logoutBtn')
         logoutBtn.addEventListener('click', function (e) {
            e.preventDefault()
            localStorage.removeItem('currentUser')
            window.location.href = 'index.html'
         })

         // טיפול בהעלאת קובץ
         const cvUploadForm = document.getElementById('cvUploadForm')
         cvUploadForm.addEventListener('submit', handleFileUpload)
      })

      function displayUserInfo() {
         document.getElementById('userFirstName').textContent = currentUser.firstName || '-'
         document.getElementById('userLastName').textContent = currentUser.lastName || '-'
         document.getElementById('userEmail').textContent = currentUser.email || '-'
         document.getElementById('userPhone').textContent = currentUser.phoneNumber || '-'
      }

      async function loadCvFileInfo() {
         try {
            const response = await fetch(`${API_BASE_URL}/users/${currentUser._id}`)
            const data = await response.json()
            
            if (data.success && data.data.cvFile) {
               showExistingFile(data.data.cvFile)
            } else {
               showUploadSection()
            }
         } catch (error) {
            console.error('שגיאה בטעינת פרטי הקובץ:', error)
            showUploadSection()
         }
      }

      function showExistingFile(cvFile) {
         document.getElementById('existingFileName').textContent = cvFile.fileName
         document.getElementById('existingFileSection').style.display = 'block'
         document.getElementById('uploadSection').style.display = 'none'
      }

      function showUploadSection() {
         document.getElementById('existingFileSection').style.display = 'none'
         document.getElementById('uploadSection').style.display = 'block'
      }

             async function handleFileUpload(e) {
          e.preventDefault()
          
          const fileInput = document.getElementById('cvFile')
          const file = fileInput.files[0]
          
          if (!file) {
             showMessage('אנא בחר קובץ להעלאה', 'warning')
             return
          }

          // בדיקת גודל הקובץ (5MB)
          if (file.size > 5 * 1024 * 1024) {
             showMessage('גודל הקובץ גדול מדי. המקסימום הוא 5MB', 'danger')
             return
          }

          // בדיקת סוג הקובץ
          const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
          if (!allowedTypes.includes(file.type)) {
             showMessage('סוג הקובץ לא נתמך. אנא בחר קובץ PDF, DOC או DOCX', 'danger')
             return
          }

          const formData = new FormData()
          formData.append('cvFile', file)

          try {
            showMessage('... מעלה קובץ', 'info')
             
             // העלאת הקובץ לשרת
             const uploadResponse = await fetch(`${API_BASE_URL}/users/${currentUser._id}/cv-upload`, {
                method: 'POST',
                body: formData
             })

             if (uploadResponse.ok) {
                const result = await uploadResponse.json()
                showMessage('! הקובץ הועלה בהצלחה', 'success')
                loadCvFileInfo() // טען מחדש את פרטי הקובץ
             } else {
                const errorData = await uploadResponse.json()
                showMessage(errorData.message || 'שגיאה בהעלאת הקובץ', 'danger')
             }
          } catch (error) {
             console.error('שגיאה בהעלאת הקובץ:', error)
             showMessage('שגיאה בהעלאת הקובץ', 'danger')
          }
       }

      async function deleteFile() {
         if (!confirm('האם אתה בטוח שברצונך למחוק את הקובץ?')) {
            return
         }

         try {
            const response = await fetch(`${API_BASE_URL}/users/${currentUser._id}/cv`, {
               method: 'DELETE'
            })

            if (response.ok) {
               showMessage('הקובץ נמחק בהצלחה', 'success')
               showUploadSection()
            } else {
               showMessage('שגיאה במחיקת הקובץ', 'danger')
            }
         } catch (error) {
            console.error('שגיאה במחיקת הקובץ:', error)
            showMessage('שגיאה במחיקת הקובץ', 'danger')
         }
      }

      async function viewFile() {
         try {
            // קבלת מידע על הקובץ מהשרת
            const response = await fetch(`${API_BASE_URL}/users/${currentUser._id}/file-info`)
            
            if (!response.ok) {
               const errorData = await response.json()
               showMessage(errorData.message || 'לא ניתן לפתוח את הקובץ', 'warning')
               return
            }
            
            const data = await response.json()
            
            if (data.success && data.data) {
               // בניית URL לדף הצפייה עם hash לשבירת cache
               const fileHash = data.data.fileHash || data.data.lastModifiedTimestamp || Date.now()
               const fileUrl = `${API_BASE_URL}/users/${currentUser._id}/view-pdf?h=${fileHash}`
               const viewerUrl = `PDFViewer.html?file=${encodeURIComponent(fileUrl)}&name=${encodeURIComponent(data.data.fileName)}&hash=${fileHash}`
               
               // פתיחת הדף באותו חלון
               window.location.href = viewerUrl
            } else {
               showMessage('לא ניתן לפתוח את הקובץ', 'warning')
            }
         } catch (error) {
            console.error('שגיאה בפתיחת הקובץ:', error)
            showMessage('שגיאה בפתיחת הקובץ', 'danger')
         }
      }

      function showMessage(message, type) {
         const messageArea = document.getElementById('messageArea')
         messageArea.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
               ${message}
               <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
               </button>
            </div>
         `
         
         // הסר את ההודעה אחרי 5 שניות
         setTimeout(() => {
            messageArea.innerHTML = ''
         }, 5000)
      }
   </script>
</html>
